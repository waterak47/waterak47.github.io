---
title: 爬取猩便利店特价信息
date: 2017-12-14 07:35:23
tags: 爬取
categories: 抓取接口
---

最近公司多了个无人售货机，经常做活动在，感觉力度还是很大的，于是抓包看了看，感觉可以做个特价商品微信推送查询功能。

<!--more-->

## 代理抓包

先扫猩猩便利店上的二维码，然后配置代理抓包。

我用的工具是Charles，大家可以用自己顺手的工具。

不会Charles抓包的同学可以看看这篇文章，[点击我查看](http://blog.devtang.com/2015/11/14/charles-introduction/#%E6%88%AA%E5%8F%96-Https-%E9%80%9A%E8%AE%AF%E4%BF%A1%E6%81%AF)

如图所示，找到步骤1的网址，在找到步骤2中的网址

![](https://ws4.sinaimg.cn/large/006tNc79gy1fmfyp59e0ij30ty0sftds.jpg)

只需要关注discount和commodityList这两个数组就行了，分别是特价信息和商品信息。

## 生成代码

如图所示，点击生成

![](https://ws4.sinaimg.cn/large/006tNc79gy1fmfys29ws8j30vd0afq5k.jpg)

代码类似如下
```bash
curl -H ':method: GET' -H ':authority: www.xingbianli.com' -H ':scheme: https' -H ':path: /openrack/猩猩便利店货架ID/commodityList?t=1513208555000' -H 'accept: application/json' -H 'origin: https://h5.xingbianli.com' -H 'user-agent: Mozilla/5.0 (Linux; Android 7.0; MHA-AL00 Build/HUAWEIMHA-AL00; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/53.0.2785.49 Mobile MQQBrowser/6.2 TBS/043632 Safari/537.36 MicroMessenger/6.5.23.1180 NetType/WIFI Language/zh_CN' -H 'referer: https://h5.xingbianli.com/app/app-openrack-h5/main.html?' -H 'accept-encoding: gzip, deflate' -H 'accept-language: zh-CN,en-US;q=0.8' -H 'cookie: xbl_uuid=生成的UUID' -H 'cookie: token=生成的TokenID' -H 'x-requested-with: ' 'https://www.xingbianli.com/openrack/猩猩便利店货架ID/commodityList?t=1513208555000'
```

将curl代码转换PHP代码，[点击我打开网站](https://incarnate.github.io/curl-to-php/)

```php
$ch = curl_init();

curl_setopt($ch, CURLOPT_URL, "https://www.xingbianli.com/openrack/猩猩便利店货架ID/commodityList?t=1513208555000");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");


$headers = array();
$headers[] = ": path: /openrack/猩猩便利店货架ID/commodityList?t=1513208555000";
$headers[] = "Accept: application/json";
$headers[] = "Origin: https://h5.xingbianli.com";
$headers[] = "User-Agent: Mozilla/5.0 (Linux; Android 7.0; MHA-AL00 Build/HUAWEIMHA-AL00; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/53.0.2785.49 Mobile MQQBrowser/6.2 TBS/043632 Safari/537.36 MicroMessenger/6.5.23.1180 NetType/WIFI Language/zh_CN";
$headers[] = "Referer: https://h5.xingbianli.com/app/app-openrack-h5/main.html?";
$headers[] = "Accept-Encoding: gzip, deflate";
$headers[] = "Accept-Language: zh-CN,en-US;q=0.8";
$headers[] = "Cookie: token=生成的TokenID";
$headers[] = "X-Requested-With: ";
curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

$result = curl_exec($ch);
if (curl_errno($ch)) {
    echo 'Error:' . curl_error($ch);
}
curl_close ($ch);

$datas = json_decode($result, true);

//获取便宜商品的价格
$discountProducts = [];

//最终输出
$products = [];

//todayPrice今日特价 name商品名称 currentPrice正常价格

foreach ($datas['data']['discount'] as $items) {
    array_push($discountProducts, $items['commodityId']);
    $products[$items['commodityId']]['todayPrice'] = $items['currentPrice'];
}

//列出便宜商品
foreach ($datas['data']['commodityList'] as $items) {
    if(in_array($items['commodityId'], $discountProducts)) {
        $products[$items['commodityId']]['name'] = $items['name'];
        $products[$items['commodityId']]['currentPrice'] = $items['basicPrice'];
        $products[$items['commodityId']]['bigPicUrl'] = $items['bigPicUrl'];
    }
}

echo json_encode($products);

```

## 结果展示

其实还有很多可以做的，比如用用Server酱进行推送，或者进行其他有意思的东东。

![](https://ws2.sinaimg.cn/large/006tNc79gy1fmfyzes1jvj31c20jcanj.jpg)